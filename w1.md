“Tech-Pulse项目 V2.0”作战计划细化（修订版：新浪财经专属）
第一周：奠定智能核心与健壮管道 (Intelligence & Robust Pipeline)
最高优先级任务：攻克AI核心 (2天)
* 目标： 实现智能分级、高效率的AI内容分析模块。
* 具体步骤：
   1. 环境准备： 安装并配置gemini API和deepseek API的Python SDK。
   2. CostAwareAnalyzer模块骨架： 创建analyzer.py文件，定义CostAwareAnalyzer类。
   3. gemini超级Prompt设计与实现：
      * 编写一个_call_gemini_api私有方法，封装gemini API调用。
      * 设计一个能一次性提取新闻“摘要”、“事件识别”（事件类型、核心实体、时间、地点）和“情绪打分”（-1到1的浮点数）的Prompt。
      * 实现Prompt模板，确保输入新闻内容后能生成有效的API请求。
      * 处理gemini API响应，解析出所需的结构化数据。
   4. deepseek降级策略实现：
      * 编写一个_call_deepseek_api私有方法，封装deepseek API调用。
      * 设计deepseek的Prompt，使其在功能上尽可能接近gemini，作为备用方案。
      * 在CostAwareAnalyzer的公共方法（如analyze_news）中，首先尝试调用_call_gemini_api。
      * 实现try-except块捕获gemini API调用失败（超时、API Key无效、API限流等）的异常。
      * 当gemini调用失败时，自动调用_call_deepseek_api进行降级处理。
   5. 预算控制模拟（可选，但推荐）： 简单实现一个内部计数器或使用Redis来模拟API调用次数和成本，当达到预设阈值时，自动将主API切换为gemini。
   6. 单元测试： 为CostAwareAnalyzer编写测试用例，验证api的调用逻辑、降级机制以及结果解析的正确性。
 
#### 1.先安装一个python第三方库aiohttp库，说明引自csdn：
aiohttp库是一个提供异步web服务的库，使用异步请求库进行数据抓取时，在程序等待服务器响应的过程中可以做一些其他的事情，比如进行请求的调度、响应的处理等，可以大大提高效率。从 Python 3.5 版本开始，Python 中加入了 async/await 关键字，使得回调的写法更加直观和人性化。aiohttp 的异步操作借助于 async/await 关键字的写法变得更加简洁，架构更加清晰。

#### 2.log输出格式：时间 - 模块名 - 级别 - 消息，便于排查调用、重试、预算等信息。

#### 3._call_api_with_retry(self, provider, news_content, is_gemini) -> Dict[str, Any>

  职责：构建 HTTP 请求 → 调用第三方 API → 解析提取文本 → 估算成本并记录 → 返回已解析的 JSON（Python dict）。

  亮点：请求/解析/记账三件事捆绑在一次重试成功路径中完成，保证统计与真实调用保持一致。
#### 4._parse_api_response(self, response_text: str) -> Dict[str, Any]
目标：从模型文本中稳妥拿到 JSON（容错）。

三次尝试（从严格到宽松）：

纯 JSON：字符串去空白后，是否以 { 开始、} 结束 → json.loads(...)

代码块 JSON：正则找 json ... 或 ... 中的 {...} → json.loads(...)

正则：r'```(?:json)?\s*(\{.*?\})\s*```'（DOTALL）

任意位置 JSON：宽松匹配第一个 {...} → json.loads(...)

三次都失败：抛 ValueError 并在日志中带出响应前 200 字做排障。

注意：如果模型输出多个 JSON 或 JSON 后面还有解释文字，第 3 条宽松匹配可能匹配不完整/错误，
* 实际中可考虑更稳健的 JSON 提取器（计数括号或 AST 方式）。

#### _estimate_cost(self, input_text, output_text, provider) -> float
粗粒度 Token 估算（经验法）：token ≈ 字符数 / 2

注意：不同模型/编码器的 token 计数差异很大，生产中建议：

使用官方 tokenizer（如 tiktoken、各家的 SDK）。

或通过返回的 usage 字段（若 API 有）作为真实计费依据。

#### analyze_news(self, news_content, force_provider=None) -> NewsAnalysisResult

#### 新增：dataclass数据类————数据结构
在Python 3.7（PEP 557）后引入一个新功能是装饰器@dataclass，它通过自动生成特殊方法（如__init__() 和 __repr__() ...等魔术方法 ）来简化数据类的创建。

dataclass相较于dict和tuple具有明显优势。它能更精确地指定每个成员变量的类型，同时提供字段名的检查，大大降低了出错的可能性。相对于传统的类定义，使用dataclass更加简洁，省去了冗长的__init__方法等，只需直接列出成员变量即可。

数据类更易于阅读和理解，类型提示使得读者更自然地理解数据的组织结构。当数据类清晰明了时，读者更容易形成准确的假设，也更容易发现并修复潜在的错误。
#### 新增：指数退避算法
指数退避调度算法（Exponential Backoff Algorithm）是一种常见的重试策略，通常用于网络请求重试、多线程并发控制和冲突检测等场景。其核心思想是：在每次重试失败后，延迟的时间呈指数增长，从而减少系统的资源消耗和避免频繁的重试冲突。

初始延迟：设置一个最小的延迟时间 (tmin)(t_{\text{min}})(t 
min )（例如 100 毫秒）。

指数增长：在每次重试失败后，延迟时间会以一定的倍数（通常是 2）增长。

最大延迟：为避免无限延迟，通常会设置一个最大延迟 (tmax)(t_{\text{max}})(t 
max )（例如 30 秒）。

随机抖动：为了避免“雪崩效应”，在延迟的基础上加入一定的随机抖动，使每个请求的延迟时间略有不同。
